<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pipepline of using multigroup cTWAS with summary statistics • ctwas</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Pipepline of using multigroup cTWAS with summary statistics">
<meta property="og:description" content="ctwas">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ctwas</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.36</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorial
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/multigroup_ctwas_pipeline.html">Pipepline of using multigroup cTWAS with summary statistics</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xinhe-lab/ctwas/tree/multigroup_test" class="external-link">Source</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="multigroup_ctwas_pipeline_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Pipepline of using multigroup cTWAS with summary statistics</h1>
                        <h4 data-toc-skip class="author">Kaixuan Luo, Sheng Qian</h4>
            
            <h4 data-toc-skip class="date">2024-03-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xinhe-lab/ctwas/blob/multigroup_test/vignettes/multigroup_ctwas_pipeline.Rmd" class="external-link"><code>vignettes/multigroup_ctwas_pipeline.Rmd</code></a></small>
      <div class="hidden name"><code>multigroup_ctwas_pipeline.Rmd</code></div>

    </div>

    
    
<p>This document shows the updated pipeline for running cTWAS with summary statistics using the <code>multi-group</code> version of the R package, which extends our earlier cTWAS method (single group version) to integrate multiple groups of prediction models.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install the <code>multigroup</code> branch of <code>cTWAS</code> package</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/remotes/man/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"xinhe-lab/ctwas"</span>, ref <span class="op">=</span> <span class="st">"multigroup"</span><span class="op">)</span></span></code></pre></div>
<p>Load the package</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xinhe-lab/ctwas" class="external-link">ctwas</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preparing-input-data">Preparing input data<a class="anchor" aria-label="anchor" href="#preparing-input-data"></a>
</h2>
<p>In this version of <code>cTWAS</code> package, we require first running the data preprocessing and harmonization steps before running parameter estimation and finemapping steps of cTWAS analysis.</p>
<p>The inputs for the summary statistics version of cTWAS include GWAS summary statistics, prediction models for genes in PredictDB format, and LD reference.</p>
<div class="section level3">
<h3 id="gwas-z-scores">GWAS z-scores<a class="anchor" aria-label="anchor" href="#gwas-z-scores"></a>
</h3>
<p>We read the GWAS summary statistics as a data frame <code>z_snp</code>, with columns “id”, “A1”, “A2”, “z”, and each row is a variant. <code>A1</code> is the alternate allele, and <code>A2</code> is the reference allele.</p>
<p>We also need to specify the GWAS sample size.</p>
</div>
<div class="section level3">
<h3 id="prediction-models">Prediction models<a class="anchor" aria-label="anchor" href="#prediction-models"></a>
</h3>
<p>The <code>multigroup</code> version of cTWAS only accepts multiple sets of prediction models in PredictDB format. We provide functions to convert weights from FUSION format to PredictDB format.</p>
<p>To specify weights in PredictDB format, provide the path to the <code>.db</code> file. Multiple prediction models can be specified by providing multiple paths as a vector.</p>
</div>
<div class="section level3">
<h3 id="ld-reference-and-region-info">LD reference and region info<a class="anchor" aria-label="anchor" href="#ld-reference-and-region-info"></a>
</h3>
<p>LD reference information can be provided as genetic correlation matrices (termed “R matrices”) for regions that are approximately LD-independent.</p>
<p>It is critical that the genome build (e.g. hg38) of the LD reference matches the genome build used to train the prediction models. The genome build of the GWAS summary statistics does not matter because variant positions are determined by the LD reference.</p>
<p>cTWAS includes pre-defined regions based on European (EUR), Asian (ASN), or African (AFR) populations, using either genome build b38 or b37. These regions were previously generated using <a href="https://github.com/endrebak/ldetect" class="external-link">LDetect</a>.</p>
<p>In this version of the package, we also require a data frame <code>region_info</code> containing the following columns: “chrom”, “start”, “end”, “region_name”, “LD_matrix”, “SNP_info”.</p>
<p>“chrom”, “start”, “end” are the genomic coordinates of the regions, “LD_matrix” stores the paths to the precomputed LD (R) matrices (<code>.RDS</code> files in our UK Biobank reference), “SNP_info” stores the paths to the variant information corresponding to the LD matrices (<code>.Rvar</code> files in our UK Biobank reference).</p>
</div>
<div class="section level3">
<h3 id="data-harmonization">Data harmonization<a class="anchor" aria-label="anchor" href="#data-harmonization"></a>
</h3>
<p>These inputs should be harmonized prior to cTWAS analysis (i.e. the reference and alternative alleles for each variant should match across all three data sources).</p>
<div class="section level4">
<h4 id="harmonizing-gwas-z-scores-and-ld-reference-and-detect-ld-mismatches">Harmonizing GWAS z-scores and LD reference and detect LD mismatches<a class="anchor" aria-label="anchor" href="#harmonizing-gwas-z-scores-and-ld-reference-and-detect-ld-mismatches"></a>
</h4>
<p>The <code><a href="../reference/preprocess_z_ld.html">preprocess_z_ld()</a></code> function first harmonizes GWAS z-scores and LD reference based on the included allele information, then performs LD mismatch diagnosis using the <code><a href="../reference/kriging_rss.html">kriging_rss()</a></code> function from SuSiE RSS, and flips signs for variants detected with allele flipping issues. Note, the LD mismatch diagnosis procedure can be time consuming.</p>
</div>
<div class="section level4">
<h4 id="harmonizing-prediction-models-and-ld-reference">Harmonizing prediction models and LD reference<a class="anchor" aria-label="anchor" href="#harmonizing-prediction-models-and-ld-reference"></a>
</h4>
<p>The <code><a href="../reference/preprocess_wgt_ld.html">preprocess_wgt_ld()</a></code> function harmonizes the PredictDB prediction models and LD reference. This only needs to be done once per combination of prediction models and LD reference.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="imputing-gene-z-scores">Imputing gene z-scores<a class="anchor" aria-label="anchor" href="#imputing-gene-z-scores"></a>
</h2>
<p>After we have done data harmonization, we compute gene z-scores genome-wide using <code><a href="../reference/compute_gene_z.html">compute_gene_z()</a></code>.</p>
<p>This function computes gene z-scores using GWAS summary statistics (<code>z_snp</code>), the PredictDB weights, and the LD matrix information included in <code>region_info</code>. It returns computed gene z-scores (<code>z_gene</code>), a data frame about the imputed genes (<code>gene_info</code>), and the weights of imputed genes (<code>wgtlist</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compute_gene_z.html">compute_gene_z</a></span><span class="op">(</span><span class="va">z_snp</span>, <span class="va">weights</span>, <span class="va">region_info</span>, <span class="va">ncore</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="estimating-parameters">Estimating parameters<a class="anchor" aria-label="anchor" href="#estimating-parameters"></a>
</h2>
<p>We need to specify the GWAS summary statistics (<code>z_snp</code>), results from computing gene z-scores (including <code>z_gene</code>, <code>gene_info</code>), and <code>region_info</code>. We also specify <code>thin</code>, the proportion of SNPs to be used for parameter estimation and screening regions.</p>
<p>In the <code>multigroup</code> branch, to specify that our gene z-scores come from multiple groups, we simply add a <code>type</code> column specifying the types of tissue groups, and we and also add a <code>QTLtype</code> column for the types of molecular traits.</p>
<p>There are several options for how to handle the effect size prior by specifying the <code>group_prior_var_stucture</code>:</p>
<ul>
<li>“independent” is the default and allows all groups to have their own separate variance parameters.</li>
<li>“shared” allows all groups to share the same variance parameter.</li>
<li>“shared+snps” allows all groups to share the same variance parameter, and this variance parameter is also shared with SNPs.</li>
<li>“shared_type” allows all groups in one molecular QTL type to share the same variance parameter.</li>
</ul>
<p>This step will run EM algorithm to estimate parameters.</p>
<p>It will first get downsampled SNPs (with <code>thin</code>) for each region, then iteratively run <code>susie_rss</code> with L = 1 (first on all regions to get rough estimates and then on filtered regions to get accurate estimates), and then estimate parameters (<code>group_prior</code> and <code>group_prior_var</code>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/est_param.html">est_param</a></span><span class="op">(</span><span class="va">z_snp</span>, <span class="va">z_gene</span>, <span class="va">region_info</span>, <span class="va">gene_info</span>, <span class="va">thin</span>, <span class="va">group_prior_var_structure</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>We could use <code><a href="../reference/ctwas_summarize_parameters.html">ctwas_summarize_parameters()</a></code> to assess the convergence of the estimated parameters and to compute the proportion of variance explained (PVE) by variants and genes.</p>
</div>
<div class="section level2">
<h2 id="screening-regions">Screening regions<a class="anchor" aria-label="anchor" href="#screening-regions"></a>
</h2>
<p>This step will run a screening process to fine-map all regions with downsampled SNPs, (we set <code>L = 1</code> as default in this version to shorten running time, instead of <code>L = 5</code> as in the earlier version), and select regions with strong gene signals (<code>min_gene_PIP = 0.5</code> by default).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/screen_regions.html">screen_regions</a></span><span class="op">(</span><span class="va">z_snp</span>, <span class="va">z_gene</span>, <span class="va">region_info</span>, <span class="va">gene_info</span>, <span class="va">wgtlist</span>, <span class="va">regionlist</span>, </span>
<span>               <span class="va">group_prior</span>, <span class="va">group_prior_var</span>, min_gene_PIP <span class="op">=</span> <span class="fl">0.5</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fine-mapping">Fine-mapping<a class="anchor" aria-label="anchor" href="#fine-mapping"></a>
</h2>
<p>We now perform the fine-mapping step with the estimated parameters for each of screened regions.</p>
<p>The <code>finemap_region</code> function performs finemapping for a single region, as specified by <code>region_tag</code>. We could run this function through each of selected regions or any region of interest.</p>
<p>It first computes correlation matrices (SNP-SNP, SNP-gene, and gene-gene correlation matrices) using all SNPs in the region, and then runs fine-mapping with L = 5 with estimated parameters (<code>group_prior</code> and <code>group_prior_var</code>), and returns a data frame with annotated finemapping results for the region.</p>
<p>If <code>save_LD_R = TRUE</code>, it will save the computed correlation matrices to <code>outputdir</code> for future access.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/finemap_region.html">finemap_region</a></span><span class="op">(</span><span class="va">z_snp</span>, <span class="va">z_gene</span>, <span class="va">region_info</span>, <span class="va">gene_info</span>, <span class="va">wgtlist</span>, <span class="va">regionlist</span>, <span class="va">region_tag</span>, </span>
<span>               L <span class="op">=</span> <span class="fl">5</span>, <span class="va">group_prior</span>, <span class="va">group_prior_var</span>, <span class="va">save_LD_R</span>, <span class="va">outputdir</span>, <span class="va">outname</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="postprocessing">Postprocessing<a class="anchor" aria-label="anchor" href="#postprocessing"></a>
</h2>
<div class="section level3">
<h3 id="rerun-finemapping-with-l-1-for-regions-with-problematic-snps">Rerun finemapping with L = 1 for regions with problematic SNPs<a class="anchor" aria-label="anchor" href="#rerun-finemapping-with-l-1-for-regions-with-problematic-snps"></a>
</h3>
<p>We will rerun the fine-mapping with L = 1 for the regions containing high PIP (&gt;0.5) SNPs detected with LD-mismatch issue in the preprocessing step, or high PIP genes with problematic SNPs in their weights.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rerun_finemap_regions_L1.html">rerun_finemap_regions_L1</a></span><span class="op">(</span><span class="va">z_snp</span>, <span class="va">z_gene</span>, <span class="va">problematic_snps</span>, <span class="va">wgtlist</span>, pip_thresh <span class="op">=</span> <span class="fl">0.5</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="region-merging">Region merging<a class="anchor" aria-label="anchor" href="#region-merging"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="visualzing-ctwas-results">Visualzing cTWAS results<a class="anchor" aria-label="anchor" href="#visualzing-ctwas-results"></a>
</h2>
<p>We could use <code><a href="../reference/ctwas_locus_plot.html">ctwas_locus_plot()</a></code> function to make locus plot for a region of interest.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Siming Zhao, Wesley Crouse, Sheng Qian, Kaixuan Luo, Matthew Stephens, Xin He.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
